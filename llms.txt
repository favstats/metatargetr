# metatargetr ![](reference/figures/metatargetr_logo.png)

The goal of `metatargetr` is to parse targeting information from the
[Meta Ad Targeting
dataset](https://developers.facebook.com/docs/fort-ads-targeting-dataset/)
and retrieve data from the [Audience
tab](https://www.facebook.com/ads/library/?active_status=all&ad_type=political_and_issue_ads&country=NL&view_all_page_id=175740570505&sort_data%5Bdirection%5D=desc&sort_data%5Bmode%5D=relevancy_monthly_grouped&search_type=page&media_type=all)
in the Meta Ad Library. It also includes helper functions for Meta ad
library data and integrates data from the Google Transparency Report.

üí° *Support Open-Source Development*

If `metatargetr` has been helpful to you, consider [supporting the
project](https://www.buymeacoffee.com/favstats)! Every contribution
keeps the maintenance work going and helps me develop new features üòä

[![Buy Me a
Coffee](https://img.buymeacoffee.com/button-api/?text=Buy%20me%20a%20coffee&emoji=&slug=favstats&button_colour=FFDD00&font_colour=000000&font_family=Arial&outline_colour=000000&coffee_colour=ffffff)](https://www.buymeacoffee.com/favstats)

------------------------------------------------------------------------

## Table of Contents

- üöÄ [Installation](#installation)
- üì¶ [Load in Package](#load-in-package)
- üéØ [Get Targeting Criteria](#get-targeting-criteria-last-30-days)
  - ‚è≥ [Last 30 Days](#get-targeting-criteria-last-30-days)
  - üóìÔ∏è [Last 7 Days](#get-targeting-criteria-last-7-days)
- üï∞Ô∏è [Retrieve Historical Targeting
  Data](#retrieve-historical-targeting-data-from-database)
- üóÇÔ∏è [Retrieve Historical Report
  Data](#retrieve-historical-report-data-from-the-database)
- ‚ÑπÔ∏è [Get Page Info](#get-page-info)
- üîç [Retrieve Targeting Metadata](#retrieve-targeting-metadata)
- üñºÔ∏è [Get Ad Snapshots (Images, Videos, and
  Metadata)](#get-ad-snapshots-images-videos-and-metadata)
  - [Single ad](#single-ad)
  - [Batch processing](#batch-processing-recommended-for-multiple-ads)
  - [Download media files](#download-media-files)
- üìÑ [Fetch and Cache Ad HTML](#fetch-and-cache-ad-html)
- üîó [Get Deeplink Data](#get-deeplink-data)
- üìä [Google Transparency Report](#google-transparency-report)
  - üí∞ [Retrieve Aggregated Spending
    Data](#retrieve-aggregated-spending-data)
  - üìà [Retrieve Time-Based Spending
    Data](#retrieve-time-based-spending-data)
- ‚úçÔ∏è [Citing metatargetr](#citing-metatargetr)

------------------------------------------------------------------------

## Installation

You can install the development version of metatargetr like so:

``` r
remotes::install_github("favstats/metatargetr")
```

## Load in Package

``` r
library(metatargetr)
```

## Get Targeting Criteria (Last 30 Days)

The following code retrieves the targeting criteria used by the main
page of the VVD (Dutch party) in the last 30 days of available data.

Just put in the right *Page ID*. These can be found in the [Meta Ad
Library](https://www.facebook.com/ads/library/) or the [Meta Ad Library
Report](https://www.facebook.com/ads/library/report/). You can also
[retrieve historical report
data](#retrieve-historical-report-data-from-the-database) from the
maintained database.

``` r

last30 <- get_targeting(id = "121264564551002", 
                        timeframe = "LAST_30_DAYS")

head(last30, 5)
#> # A tibble: 0 √ó 7
#> # ‚Ñπ 7 variables: ds <chr>, main_currency <chr>, total_num_ads <int>,
#> #   total_spend_formatted <chr>, is_30_day_available <lgl>,
#> #   is_90_day_available <lgl>, page_id <chr>
```

## Get Targeting Criteria (Last 7 Days)

The following code retrieves the targeting criteria used by the main
page of the VVD (Dutch party) in the last 7 days. Just put in the right
Page ID.

``` r
last7 <- get_targeting(id = "121264564551002", 
                       timeframe = "LAST_7_DAYS")


head(last7, 5)
#> # A tibble: 0 √ó 7
#> # ‚Ñπ 7 variables: ds <chr>, main_currency <chr>, total_num_ads <int>,
#> #   total_spend_formatted <chr>, is_30_day_available <lgl>,
#> #   is_90_day_available <lgl>, page_id <chr>
```

## Retrieve *Historical* Targeting Data from Database

Unfortunately, using `get_targeting` **you can only get the targeting
criteria in the last 7, 30, and 90 days windows**. However, I have set
up scrapers that retrieve the daily targeting data for every single page
in the world that runs advertisements in order to archive this data. You
can use the function below to retrieve it.

> Be aware: sometimes the scrapers do not work so it is possible that
> some pages are missing. You can use
> [`get_targeting_metadata`](#get-targeting-metadata) function to check
> which data for which country and day is present.

``` r
# # set some parameters
the_cntry <- "DE"
tf <- 30
ds <- "2024-10-25"

# # Call the function
latest_data <- get_targeting_db(the_cntry, tf, ds)

# # Inspect the data
head(latest_data)
#> # A tibble: 6 √ó 37
#>   internal_id no_data tstamp              page_id  cntry page_name partyfacts_id
#>   <chr>       <lgl>   <dttm>              <chr>    <chr> <chr>     <chr>        
#> 1 <NA>        NA      2024-10-27 19:12:35 7440553‚Ä¶ DE    CDU-Frak‚Ä¶ 1375         
#> 2 <NA>        NA      2024-10-27 19:12:35 7440553‚Ä¶ DE    CDU-Frak‚Ä¶ 1375         
#> 3 <NA>        NA      2024-10-27 19:12:35 7440553‚Ä¶ DE    CDU-Frak‚Ä¶ 1375         
#> 4 <NA>        NA      2024-10-27 19:12:35 7440553‚Ä¶ DE    CDU-Frak‚Ä¶ 1375         
#> 5 <NA>        NA      2024-10-27 19:12:35 7440553‚Ä¶ DE    CDU-Frak‚Ä¶ 1375         
#> 6 <NA>        NA      2024-10-27 19:12:35 7440553‚Ä¶ DE    CDU-Frak‚Ä¶ 1375         
#> # ‚Ñπ 30 more variables: sources <chr>, country <chr>, party <chr>,
#> #   left_right <dbl>, tags <glue>, tags_ideology <chr>, disclaimer <chr>,
#> #   amount_spent_eur <chr>, number_of_ads_in_library <chr>, date <chr>,
#> #   path <chr>, tf <chr>, remove_em <lgl>, total_n <int>, amount_spent <dbl>,
#> #   value <chr>, num_ads <int>, total_spend_pct <dbl>, type <chr>,
#> #   location_type <chr>, num_obfuscated <int>, is_exclusion <lgl>, ds <chr>,
#> #   main_currency <chr>, total_num_ads <int>, total_spend_formatted <dbl>, ‚Ä¶
```

## Retrieve *Historical* Report Data from the Database

Using `get_report_db`, you can retrieve archived advertising reports for
specific pages, countries, and timeframes. Reports are stored in a
repository and can be downloaded and read directly into R.

> Note: While we strive to keep the archive complete, occasional scraper
> failures may lead to missing data for certain days.

``` r
# # set some parameters
the_cntry <- "DE"
tf <- 30
ds <- "2024-10-25"

# # Call the function
latest_data <- get_report_db(the_cntry, tf, ds)

# # Inspect the data
head(latest_data)
#> # A tibble: 6 √ó 9
#>   page_id     page_name disclaimer amount_spent_eur number_of_ads_in_lib‚Ä¶¬π date 
#>   <chr>       <chr>     <chr>      <chr>            <chr>                  <chr>
#> 1 2781178155‚Ä¶ EU Justi‚Ä¶ EU Justic‚Ä¶ 296508           28                     2024‚Ä¶
#> 2 1706886445‚Ä¶ UNICEF D‚Ä¶ UNICEF De‚Ä¶ 78283            79                     2024‚Ä¶
#> 3 1891313609‚Ä¶ LIQID In‚Ä¶ LIQID Inv‚Ä¶ 76300            88                     2024‚Ä¶
#> 4 1918513976‚Ä¶ VETO ‚Äì T‚Ä¶ VETO - Ti‚Ä¶ 71581            218                    2024‚Ä¶
#> 5 23216224900 Plan Int‚Ä¶ Plan Inte‚Ä¶ 62605            62                     2024‚Ä¶
#> 6 1612732458‚Ä¶ Save the‚Ä¶ Save the ‚Ä¶ 59891            195                    2024‚Ä¶
#> # ‚Ñπ abbreviated name: ¬π‚Äãnumber_of_ads_in_library
#> # ‚Ñπ 3 more variables: path <chr>, tf <chr>, cntry <chr>
```

## Get Page Info

You can also retrieve some page info of the page that you are interested
in.

``` r
page_info <- get_page_insights("121264564551002", include_info = "page_info")


str(page_info)
#> 'data.frame':    1 obs. of  20 variables:
#>  $ page_name             : chr "VVD"
#>  $ is_profile_page       : chr "FALSE"
#>  $ page_is_deleted       : chr "FALSE"
#>  $ page_is_restricted    : chr "FALSE"
#>  $ has_blank_ads         : chr "FALSE"
#>  $ hidden_ads            : chr "0"
#>  $ page_profile_uri      : chr "https://facebook.com/VVD"
#>  $ page_id               : chr "121264564551002"
#>  $ page_verification     : chr "BLUE_VERIFIED"
#>  $ entity_type           : chr "PERSON_PROFILE"
#>  $ page_alias            : chr "VVD"
#>  $ likes                 : chr "109676"
#>  $ page_category         : chr "Political party"
#>  $ ig_verification       : chr "TRUE"
#>  $ ig_username           : chr "vvd"
#>  $ ig_followers          : chr "54188"
#>  $ shared_disclaimer_info: chr "[]"
#>  $ about                 : chr "Een sterk en veilig Nederland. Met rust in je portemonnee en alle ruimte voor jou om te groeien en iets op te b"| __truncated__
#>  $ event                 : chr "CREATION: 2010-04-23 21:05:02"
#>  $ no_address            : logi TRUE
```

## `get_targeting_metadata()`

The `get_targeting_metadata` function is designed to retrieve metadata
about targeting data releases from a GitHub repository to see which data
is present (or not). It extracts and organizes information such as file
names, sizes, timestamps, and tags for a specified country and
timeframe. **This metadata provides an overview of the available
targeting data without downloading the actual files.**

- `country_code` (*Character*):  
  The ISO country code (e.g., `"DE"` for Germany, `"US"` for the United
  States).

- `timeframe` (*Character*):  
  The timeframe for the targeting data. Acceptable values are:

  - `"7"`: Last 7 days.
  - `"30"`: Last 30 days.
  - `"90"`: Last 90 days.

- `base_url` (*Character*, default:
  `"https://github.com/favstats/meta_ad_targeting/releases/expanded_assets/"`):  
  The base URL for the GitHub repository hosting the targeting data.

``` r

# Retrieve metadata for Germany for the last 30 days
metadata <- get_targeting_metadata("DE", "30")

print(metadata)
#> # A tibble: 695 √ó 3
#>    cntry ds         tframe      
#>    <chr> <chr>      <chr>       
#>  1 DE    2026-02-15 last_30_days
#>  2 DE    2026-02-14 last_30_days
#>  3 DE    2026-02-13 last_30_days
#>  4 DE    2026-02-12 last_30_days
#>  5 DE    2026-02-11 last_30_days
#>  6 DE    2026-02-10 last_30_days
#>  7 DE    2026-02-09 last_30_days
#>  8 DE    2026-02-08 last_30_days
#>  9 DE    2026-02-07 last_30_days
#> 10 DE    2026-02-06 last_30_days
#> # ‚Ñπ 685 more rows
```

## Get Ad Snapshots (Images, Videos, and Metadata)

[`get_ad_snapshots()`](reference/get_ad_snapshots.md) retrieves snapshot
data for a Facebook ad from the Ad Library, including images, videos,
cards, body text, page info, and more. It uses headless Chrome (via
chromote) to bypass Facebook‚Äôs JavaScript-based bot detection.

This piece of code was created in collaboration with [Philipp
Mendoza](https://www.uva.nl/en/profile/m/e/p.m.mendoza/p.m.mendoza.html).

### Single ad

``` r
snap <- get_ad_snapshots("561403598962843")
```

### Batch processing (recommended for multiple ads)

For best performance when processing multiple ads, use a persistent
browser session. This passes Facebook‚Äôs JS challenge once during
startup, so all subsequent calls are fast.

``` r
browser_session_start()

results <- map_dfr_progress(ad_ids, ~get_ad_snapshots(.x))

browser_session_close()
```

If Chrome becomes unresponsive mid-batch, use
[`browser_session_restart()`](reference/browser_session_restart.md) to
recover without restarting R.

### Download media files

Setting `download = TRUE` saves images and videos to disk. Use
`hashing = TRUE` to deduplicate media files (recommended for large-scale
collection).

``` r
get_ad_snapshots("561403598962843", download = TRUE, hashing = TRUE, mediadir = "data/media")
```

## Fetch and Cache Ad HTML

[`get_ad_html()`](reference/get_ad_html.md) fetches the raw HTML for one
or more ads and caches results to disk as gzipped files. Useful for
archiving or downstream parsing with `parse_ad_htmls()`.

``` r
paths <- get_ad_html(
  ad_ids  = c("561403598962843", "1103135646905363"),
  country = "US"
)
```

## Get Deeplink Data

[`get_deeplink()`](reference/get_deeplink.md) extracts the full
`deeplinkAdCard` JSON object from an ad page, which contains additional
metadata beyond what
[`get_ad_snapshots()`](reference/get_ad_snapshots.md) returns (e.g.,
`fevInfo`, `free_form_additional_info`, `learn_more_content`).

``` r
dl <- get_deeplink("561403598962843")
```

## Google Transparency Report

`ggl_get_spending` is a function in R that queries the Google
Transparency Report to retrieve information about advertising spending
for a specified advertiser. It supports a range of countries and can
provide either aggregated data or time-based spending data.

To use `ggl_get_spending`, you need the advertiser‚Äôs unique identifier,
the desired date range, and the country code. The function also has an
option to retrieve time-based spending data.

### Retrieve Aggregated Spending Data

Retrieve aggregated spending data for a specific advertiser in the
Netherlands. It returns details like currency, number of ads, ad type
breakdown, advertiser details, and other metrics.

``` r

ggl_get_spending(advertiser_id = "AR18091944865565769729", 
                 start_date = "2023-10-24", 
                 end_date = "2023-11-22",
                 cntry = "NL")
#> # A tibble: 1 √ó 2
#>   spend number_of_ads
#>   <dbl>         <dbl>
#> 1     0             0
```

### Retrieve Time-Based Spending Data

Retrieve time-based spending data for the same advertiser and country.
If `get_times` is set to `TRUE`, it returns a tibble with date-wise
spending data.

``` r
# Retrieve time-based spending data for the same advertiser and country
timeseries_dat <- ggl_get_spending(advertiser_id = "AR18091944865565769729",
                                   start_date = "2023-10-24",
                                   end_date = "2023-11-22",
                                   cntry = "NL",
                                   get_times = TRUE)

# Plotting the time-series data
timeseries_dat %>%
    ggplot2::ggplot(ggplot2::aes(x = date, y = spend)) +
    ggplot2::geom_col() +
    ggplot2::theme_minimal()
```

------------------------------------------------------------------------

## Citing `metatargetr`

If you use the `metatargetr` package or data from its database in your
research, publications, or other outputs, please ensure you provide
proper attribution. This helps recognize the effort and resources
required to maintain and provide access to these data.

### Citation Format

> Votta, Fabio, & Mendoza, Philipp. (2024). `metatargetr`: A package for
> parsing and analyzing ad library and targeting data. GitHub. Available
> at: <https://github.com/favstats/metatargetr>

### BibTeX Entry

``` bibtex
@misc{votta2024metatargetr,
  author = {Votta, Fabio and Mendoza, Philipp},
  title = {metatargetr: A package for parsing and analyzing ad library and targeting data},
  year = {2024},
  publisher = {GitHub},
  url = {https://github.com/favstats/metatargetr}
}
```

### Additional Notes

If you use data from the `metatargetr` database, please include the
following acknowledgement in your work:

> Data were retrieved from the `metatargetr` database, maintained by
> Fabio Votta. The database archives targeting data from the Meta Ad
> Library and Google Transparency Report. For more information, visit
> <https://github.com/favstats/metatargetr>.

By including these citations and acknowledgements, you help support the
continued development of `metatargetr` and its associated resources.
Thank you for your collaboration!

------------------------------------------------------------------------

# Package index

## All functions

- [`aggr_targeting()`](aggr_targeting.md) : Aggregate a Pre-Combined
  Targeting Dataset
- [`browser_close()`](browser_close.md) : Closes a Playwright browser
  instance
- [`browser_session_active()`](browser_session_active.md) : Check if a
  persistent browser session is active
- [`browser_session_close()`](browser_session_close.md) : Close the
  persistent browser session
- [`browser_session_restart()`](browser_session_restart.md) : Restart
  the persistent browser session
- [`browser_session_start()`](browser_session_start.md) : Start a
  persistent browser session
- [`check_hash()`](check_hash.md) : Check hash of a media file
- [`create_necessary_dirs()`](create_necessary_dirs.md) : Create
  necessary directories
- [`detectmysnap()`](detectmysnap.md) : Detect and parse the snapshot
  JSON from a Facebook Ad Library script tag
- [`detectmysnap_dep()`](detectmysnap_dep.md) : Detect the JSON code on
  Facebook ad websites
- [`download_media()`](download_media.md) : Download media files and
  potentially hash them
- [`download_media_int()`](download_media_int.md) : Download media files
  with specified IDs
- [`extract_media_urls()`](extract_media_urls.md) : Extract media URLs
  from data
- [`find_name()`](find_name.md) : Find an object in a nested list by
  name
- [`fix_json()`](fix_json.md) : Parse JSON-formatted strings into named
  character vectors
- [`get_ad_html()`](get_ad_html.md) : Fetch Facebook Ad-Library pages
  (with caching)
- [`get_ad_library_page_id()`](get_ad_library_page_id.md) : Resolve
  Facebook Handles to Ad Library Page IDs
- [`get_ad_report()`](get_ad_report.md) : Get Facebook Ad Library Report
  Data
- [`get_ad_snapshots()`](get_ad_snapshots.md) : Get ad snapshots from
  Facebook Ad Library
- [`get_additional_page_info_db()`](get_additional_page_info_db.md) :
  Get Page Info Dataset for a Specific Country
- [`get_ads_info()`](get_ads_info.md) : Get and Parse Ad Library Data
- [`get_deeplink()`](get_deeplink.md) : Extract and flatten
  'deeplinkAdCard' JSON from a Facebook Ad Library page
- [`get_ggl_ads()`](get_ggl_ads.md) : Fetch a Google Ads Transparency
  Report
- [`get_linkedin_ads()`](get_linkedin_ads.md) : Retrieve Ad Data from
  the LinkedIn Ad Library with Pagination
- [`get_page_info_db()`](get_page_info_db.md) : Get Page Info Dataset
  for a Specific Country
- [`get_page_insights()`](get_page_insights.md) : Get Page Insights
- [`get_report_db()`](get_report_db.md) : Retrieve Report Data from
  GitHub Repository
- [`get_targeting()`](get_targeting.md) : Get Meta Ad Library targeting
  data for a page
- [`get_targeting_db()`](get_targeting_db.md) : Retrieve Targeting Data
  from GitHub Repository
- [`get_targeting_metadata()`](get_targeting_metadata.md) : Retrieve
  Metadata for Targeting Data
- [`ggl_get_spending()`](ggl_get_spending.md) : Retrieve Google Ad
  Spending Data
- [`map_dfr_progress()`](map_dfr_progress.md) : Apply a function to each
  element of a list with a progress bar
- [`parse_linkedin_ads_details()`](parse_linkedin_ads_details.md) :
  Parse Important Information from an Ad Detail HTML Page
- [`parse_location()`](parse_location.md) : Parse Location from Ad
  Targeting Dataset
- [`search_ad_library()`](search_ad_library.md) : Search the Facebook Ad
  Library
- [`set_metatargetr_options()`](set_metatargetr_options.md) :
  Interactively Set and Save User Settings
- [`stupid_conversion()`](stupid_conversion.md) : Convert an entry for
  an ad into a row in a tibble
- [`unnest_and_fix_dups()`](unnest_and_fix_dups.md) : Unnest interest
  targeting data
- [`walk_progress()`](walk_progress.md) : Walk through a list with a
  progress bar

# Articles

### Get Started

- [Introduction to metatargetr](introduction.md):

  Get started with metatargetr, learn about its core functionality and
  basic usage.

### Working with Targeting Data

- [Retrieving Targeting Data](retrieving-targeting-data.md):

  Learn how to retrieve and analyze Meta Ad targeting data for different
  time periods.

- [Retrieve Historical Data](retrieve-historical-data.md):

  Learn how to access and work with historical Meta Ad targeting data
  from the archive.

- [Retrieve Targeting Metadata](retrieve-targeting-metadata.md):

  Understand how to work with targeting metadata and check data
  availability.

### Google Transparency Integration

- [Google Transparency Report
  Integration](google-transparency-report.md):

  Learn how to access and analyze data from the Google Transparency
  Report.
